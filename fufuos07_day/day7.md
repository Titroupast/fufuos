| **unknow**               | **出现位置**                        | **爱莉希雅的简洁解释**                                       | **核心作用**                                                 |
| ------------------------ | ----------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **FIFO**                 | **全篇**                            | **F**irst **I**n, **F**irst **O**ut（先进先出）。[cite: 129] 就像排队买票一样，先来的数据先被处理，顺序不会乱。 | 用来做**缓冲区**（Buffer），确保数据处理的顺序性，例如键盘按键的顺序 。 |
| **按键编码**             | 1. 获取按键编码                     | 键盘按下或松开时，硬件发送给计算机的一串**十六进制数字**（扫描码）。 | 计算机通过它知道**按了哪个键**，以及是**按下**还是**松开**。 |
| **PIC**                  | 1. 获取按键编码                     | **P**rogrammable **I**nterrupt **C**ontroller（可编程中断控制器）。它是管理中断的硬件芯片。 | 负责告诉 CPU **“有中断发生啦！”**，并且接收 CPU 的**“我已经处理完啦”**通知 。 |
| **IRQ-01 / IRQ-12**      | 1. 获取按键编码 / 6. 总算讲到鼠标了 | **I**nterrupt **R**e**q**uest（中断请求）。IRQ-01 专门给**键盘**，IRQ-12 专门给 **PS/2 鼠标** 。 | 不同的硬件通过不同的 IRQ 线向 PIC 发送中断信号。             |
| **PORT_KEYDAT (0x0060)** | 1. 获取按键编码                     | **端口地址**。键盘和鼠标共用的**数据端口**。CPU 从这个地址读出按键或鼠标的数据 。 | 中断发生时，CPU 从这里获取到具体的数据（比如按键编码）。     |
| **PIC0_OCW2**            | 1. 获取按键编码                     | PIC0 的 **操作命令字2 (OCW2)** 端口。CPU 往这里写数据来**通知 PIC** 中断已被受理。 | 用来通知 PIC **“IRQ-xx 已经受理完毕”**，以便 PIC 重新开始监视该中断。 |
| **io_cli() / io_sti()**  | 2. 加快中断处理                     | 机器指令：`CLI` (C**l**ear **I**nterrupt) 和 `STI` (**S**e**t** **I**nterrupt)。 | **`io_cli()`** **屏蔽（禁止）中断**，防止关键代码执行时被中断打断，造成混乱。**`io_sti()`** **开放中断**。 |
| **io_stihlt()**          | 2. 加快中断处理                     | 机器指令 `STI` 紧跟着 `HLT` 的组合函数。                     | **先开放中断，紧接着让 CPU 休息** (`HLT`)。能确保在开放中断和 CPU 休息的**极短间隙**内，不会有中断插进来导致数据丢失。 |

------



### 🎀 Day 7（FIFO与鼠标控制）主要做了什么？



#### 🎯 **目标：优化中断处理，激活鼠标**



1. **🚀 优化键盘中断处理速度 (hiarib04a - hiarib04b)**

   - 最初：中断程序（`inthandler21`）里直接进行**耗时**的字符显示 。

   

   - 优化：将**耗时操作**（字符显示）移出中断程序 ，中断程序只做**快速接收和存储**数据的工作 。

     

   - 核心思想：**中断处理必须干净利落！**

     

2. **🔄 研发高效的 FIFO 缓冲区 (hiarib04c - hiarib04e)**

   - 问题：简单的单字节缓冲区会**丢失数据**（比如右Ctrl键产生的双字节编码 `E01D`）。

     

   - 第一版 FIFO：使用数组和 `next` 变量，解决了多字节存储问题，但主程序在取数据时需要**耗时的数据移送操作** 。

     

   - **最终版 FIFO (循环缓冲区)**：引入了**写入位置 (`next_w`)** 和**读出位置 (`next_r`)**，当位置到达末尾时，**强制回到 0** 。**彻底消除了数据移送操作** 。

     

   - 整理：将 FIFO 功能**抽象并封装**为通用的 `struct FIFO8` 和相关函数 (`fifo.c`)，方便键盘和鼠标共同使用 。

     

3. **🖱️激活并接收鼠标数据**

   - 发现：鼠标（IRQ12）默认是**不产生中断信号**的 。

     

   - 操作：通过向键盘控制电路发送指令 (`0xd4`)，再向鼠标发送**激活指令**，成功让鼠标开始发送数据 。

     

   - 实现：编写了鼠标中断处理函数 `inthandler2c`（IRQ12），它和键盘处理函数类似，将数据存入**独立的鼠标 FIFO 缓冲区** 。

     

   - 结果：`HariMain` 循环**同时检查**键盘和鼠标的 FIFO 状态 ，成功接收到鼠标的应答数据（`FA`）和滚动数据，**键盘和鼠标都能正常响应了** 。

     

### 📄 文件改动详解

*   **`fifo.c` (✨ 全新文件)**
    *   **作用**: 实现了通用的先进先出（FIFO）循环缓冲区。
    *   **核心**: 提供了 `fifo8_init`, `fifo8_put`, `fifo8_get`, `fifo8_status` 四个函数，用于管理键盘和鼠标数据的暂存，是加快中断处理的关键。

*   **`dsctbl.c` (🔧 修改)**
    *   **作用**: 初始化GDT和IDT。
    *   **Day 7 改动**: 在 `init_gdtidt` 函数中，新增了对键盘中断（`0x21`）和鼠标中断（`0x2c`）的门描述符设置，将硬件中断与 `asm_inthandler` 汇编入口点关联起来。

*   **`int.c` (🔧 修改)**
    *   **作用**: 负责中断处理的具体逻辑。
    *   **Day 7 改动**:
        *   实现了 `init_pic` 函数，用于初始化8259A PIC，屏蔽不需要的中断，并设定中断号范围。
        *   实现了 `inthandler21` 和 `inthandler2c`，这两个是C语言中断处理函数。它们从硬件端口读取数据，然后立刻调用 `fifo8_put` 将数据存入对应的FIFO缓冲区。

*   **`bootpack.c` (🔧 修改)**
    *   **作用**: 操作系统主程序。
    *   **Day 7 改动**:
        *   在 `HariMain` 开头，为键盘和鼠标分别申请内存并初始化了 `FIFO8` 缓冲区。
        *   修改了主循环 `for(;;)`，不再直接等待键盘输入，而是通过 `fifo8_status` 检查键盘和鼠标缓冲区是否有数据。
        *   新增了鼠标激活逻辑，通过 `wait_KBC_sendready` 和 `io_out8` 向鼠标控制器发送指令。
        *   主循环中增加了对鼠标数据的处理和显示逻辑。

*   **`bootpack.h` (🔧 修改)**
    *   **作用**: 全局头文件，定义共享的结构体、常量和函数原型。
    *   **Day 7 改动**:
        *   新增了 `struct FIFO8` 结构体定义和 `fifo.c` 的函数原型。
        *   新增了 `int.c` 的函数原型（`init_pic`, `inthandler21` 等）和PIC相关的端口常量。
        *   新增了 `naskfunc.nas` 中汇编中断入口点 `asm_inthandler2c` 的原型声明。

*   **`naskfunc.nas` (🔧 修改)**
    *   **作用**: 底层汇编函数库。
    *   **Day 7 改动**: 新增了 `_asm_inthandler2c`，作为鼠标中断（IRQ12）的底层入口点。它负责保存寄存器、调用C语言的 `_inthandler2c`，然后恢复寄存器并返回。

*   **`Makefile` (🔧 修改)**
    *   **作用**: 项目构建脚本。
    *   **Day 7 改动**: 在编译和链接规则中，新增了对 `fifo.c` 和 `int.c` 两个新源文件的处理，确保它们能被正确编译并链接到最终的操作系统镜像中。
     