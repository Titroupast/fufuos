### 📄 **`fifo.c` - FIFO 循环缓冲区实现**

### 🌟 0. 概览与定位

*   **文件类型:** C 语言源文件
*   **文件作用:** 实现一个通用的先进先出（FIFO）循环缓冲区，用于缓存来自键盘、鼠标等中断的输入数据。
*   **本次更新亮点:** 这是 Day 7 新增的核心文件，旨在通过引入缓冲区机制，将中断处理程序中的数据暂存起来，从而**加快中断处理速度**，避免数据丢失。

### 💖 1. 核心数据结构

*   **结构体名称:** `struct FIFO8` (定义于 `bootpack.h`)
*   **作用:** 描述一个 8 位（`unsigned char`）数据的 FIFO 循环缓冲区。
*   **成员列表:**
    *   `buf`: `unsigned char *`，指向实际存储数据的内存区域。
    *   `p`: `int`，下一个数据的写入位置（put）。
    *   `q`: `int`，下一个数据的读出位置（get）。
    *   `size`: `int`，缓冲区的总大小。
    *   `free`: `int`，缓冲区的剩余空间大小。
    *   `flags`: `int`，用于存放缓冲区的状态，例如是否发生了溢出。

### ✨ 2. 关键函数分析

#### A. `fifo8_init`

*   **功能描述:** 初始化一个 `FIFO8` 缓冲区。
*   **参数:**
    *   `fifo` (`struct FIFO8 *`): 指向要初始化的 FIFO 结构体的指针。
    *   `size` (`int`): 缓冲区的总容量。
    *   `buf` (`unsigned char *`): 指向用于存储数据的外部缓冲区的指针。
*   **核心逻辑:**
    1.  将 `size` 和 `buf` 分配给 `fifo` 结构体成员。
    2.  初始化 `free` 为 `size`，表示缓冲区是空的。
    3.  清空 `flags` 标志位。
    4.  将读写指针 `p` 和 `q` 都设置为 0。

#### B. `fifo8_put`

*   **功能描述:** 向 FIFO 缓冲区中写入一个字节的数据。
*   **参数:**
    *   `fifo` (`struct FIFO8 *`): 目标 FIFO 缓冲区的指针。
    *   `data` (`unsigned char`): 要写入的数据。
*   **核心逻辑:**
    1.  检查 `fifo->free` 是否为 0。如果是，表示缓冲区已满，设置溢出标志 `FLAGS_OVERRUN` 并返回 -1。
    2.  如果缓冲区未满，将 `data` 存入 `fifo->buf[fifo->p]` 位置。
    3.  将写入指针 `fifo->p` 加 1。
    4.  **循环逻辑:** 检查 `fifo->p` 是否等于 `fifo->size`。如果是，则将其重置为 0，实现循环。
    5.  将 `fifo->free` 减 1，表示可用空间减少。
    6.  返回 0 表示成功。

#### C. `fifo8_get`

*   **功能描述:** 从 FIFO 缓冲区中读取一个字节的数据。
*   **参数:**
    *   `fifo` (`struct FIFO8 *`): 目标 FIFO 缓冲区的指针。
*   **核心逻辑:**
    1.  检查 `fifo->free` 是否等于 `fifo->size`。如果是，表示缓冲区为空，直接返回 -1。
    2.  如果缓冲区中有数据，从 `fifo->buf[fifo->q]` 位置读取数据。
    3.  将读出指针 `fifo->q` 加 1。
    4.  **循环逻辑:** 检查 `fifo->q` 是否等于 `fifo->size`。如果是，则将其重置为 0，实现循环。
    5.  将 `fifo->free` 加 1，表示可用空间增加。
    6.  返回读取到的数据。

#### D. `fifo8_status`

*   **功能描述:** 返回当前 FIFO 缓冲区中已存储的数据量。
*   **参数:**
    *   `fifo` (`struct FIFO8 *`): 目标 FIFO 缓冲区的指针。
*   **核心逻辑:**
    *   通过 `fifo->size - fifo->free` 计算并返回已用空间的大小。

### 📝 3. 变量与常量定义

*   **全局变量:**
    *   无
*   **宏定义/常量:**
    *   `#define FLAGS_OVERRUN`: `0x0001`，用于在 `fifo->flags` 中标记缓冲区是否发生溢出。

### 💡 4. 与 Day 7 核心内容的关联

*   **加快中断处理:** 该文件是 Day 7 “加快中断处理”主题的核心实现。通过 `fifo8_put` 函数，中断处理程序（如键盘中断）可以非常迅速地将接收到的数据存入缓冲区，然后立即结束中断，而无需等待应用程序处理。这大大缩短了中断的禁用时间。
*   **实现循环 FIFO:** `fifo.c` 文件完整地实现了循环 FIFO 队列。
*   **数据读写位置的循环逻辑:** 在 `fifo8_put` 和 `fifo8_get` 函数中，通过 `if (fifo->p == fifo->size) { fifo->p = 0; }` 和 `if (fifo->q == fifo->size) { fifo->q = 0; }` 这样的代码，实现了对读写指针 `p` 和 `q` 的循环重置，当指针到达缓冲区末尾时，会自动回到开头，从而实现了循环利用缓冲区空间。
