# `int.c` 文件解析

`int.c` 文件负责中断管理。它的主要工作是初始化可编程中断控制器 (PIC)，并提供中断处理程序的C语言部分。

## `init_pic()`

这个函数执行了对两片 PIC 芯片（主片和从片）的复杂初始化序列。PIC 是管理外设中断请求的关键硬件。
1.  **屏蔽所有中断**: 函数开始时，它会禁用主从 PIC 上的所有中断。这是一个安全措施，防止在配置过程中有任何中断意外触发。
2.  **初始化命令字 (ICW)**: 它向两个 PIC 发送一系列命令来配置它们的行为。
    -   `ICW1`: 通知 PIC 准备接收后续的配置命令。
    -   `ICW2`: **中断重映射**。默认情况下，硬件中断请求 (IRQ 0-15) 会与 CPU 的内部异常冲突。此命令将 IRQ 0-7 重映射到中断号 0x20-0x27，将 IRQ 8-15 重映射到 0x28-0x2f，这是一个安全的范围。
    -   `ICW3`: 配置主从关系。它告诉主 PIC，从 PIC 连接在其 IRQ 2 引脚上，并告诉从 PIC 它的身份。
    -   `ICW4`: 设置额外的工作参数，例如缓冲区模式。
3.  **设置初始屏蔽**: 配置完成后，它设置了两个 PIC 的中断屏蔽寄存器 (IMR)。`io_out8(PIC0_IMR, 0xfb)` 允许来自从 PIC 的中断（通过 IRQ 2），而 `io_out8(PIC1_IMR, 0xff)` 则暂时屏蔽了所有来自从 PIC 设备的中断。这些屏蔽位稍后会在 `bootpack.c` 中被修改，以启用键盘和鼠标等特定设备。

## 中断处理程序

这个文件定义了由汇编语言中断包装器调用的C函数。

### `inthandler21()` (键盘) 和 `inthandler2c()` (鼠标)
这两个分别是键盘 (INT 0x21) 和鼠标 (INT 0x2c) 的中断处理函数。
-   **当前行为**: 在目前的状态下，它们只是简单的占位符。它们会在屏幕上打印一条消息，指明发生了哪个中断。
-   **系统冻结**: 关键在于，打印消息后，它们都进入了一个无限循环 `for (;;) { io_hlt(); }`。这将导致操作系统在第一次按下键盘或移动鼠标时完全冻结。
-   **缺失的逻辑**: 一个完整的中断处理程序需要执行以下步骤：
    1.  从设备读取数据（例如，从键盘读取扫描码）。
    2.  处理数据。
    3.  向 PIC 发送“中断结束”(End of Interrupt, EOI) 信号。这是至关重要的一步，它通知 PIC 可以接收新的中断了。
    4.  从中断处理程序返回（而不是永远循环）。

### `inthandler27()` (伪中断)
-   在一些旧硬件上，IRQ 7 有时会因为电气噪声而被触发，产生“伪中断”或“幽灵中断”。如果不处理，PIC 会一直等待一个永远不会到来的 EOI 信号，从而导致系统冻结。
-   这个处理程序的唯一工作就是向主 PIC 发送一个特定的 EOI 命令 (`0x67`)，以确认 IRQ 7 中断已经收到。然后它立即返回，让系统可以继续正常运行。这是一个简单但重要的硬件兼容性逻辑。
